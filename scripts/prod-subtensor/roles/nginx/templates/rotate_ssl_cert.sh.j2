#!/bin/bash
# SSL Certificate rotation script for Subtensor
# Generated by Ansible - DO NOT EDIT MANUALLY

LOG_FILE="/var/log/ssl_rotation.log"
CERT_PATH="/etc/nginx/ssl/subtensor_cert.pem"
KEY_PATH="/etc/nginx/ssl/subtensor_key.pem"
BACKUP_DIR="/etc/nginx/ssl/backup"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_message "Starting SSL certificate rotation for Subtensor"

# Backup existing certificates
if [ -f "$CERT_PATH" ] && [ -f "$KEY_PATH" ]; then
    log_message "Backing up existing certificates"
    cp "$CERT_PATH" "$BACKUP_DIR/subtensor_cert_$(date +%Y%m%d_%H%M%S).pem"
    cp "$KEY_PATH" "$BACKUP_DIR/subtensor_key_$(date +%Y%m%d_%H%M%S).pem"
fi

# Generate new certificates
log_message "Generating new SSL certificates"
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -sha256 \
    -keyout "$KEY_PATH" \
    -out "$CERT_PATH" \
    -subj "/C={{ nginx_cert_country | default('US') }}/ST={{ nginx_cert_state | default('State') }}/L={{ nginx_cert_locality | default('City') }}/O={{ nginx_cert_organization | default('Subtensor Production') }}/CN={{ ansible_host }}"

if [ $? -eq 0 ]; then
    log_message "New certificates generated successfully"

    # Set proper permissions
    chmod 600 "$CERT_PATH" "$KEY_PATH"
    chown root:root "$CERT_PATH" "$KEY_PATH"

    # Test NGINX configuration
    nginx -t
    if [ $? -eq 0 ]; then
        log_message "NGINX configuration test passed, reloading NGINX"
        systemctl reload nginx
        log_message "NGINX reloaded successfully"
    else
        log_message "ERROR: NGINX configuration test failed, restoring backup certificates"
        # Restore backup if available
        LATEST_CERT_BACKUP=$(ls -t "$BACKUP_DIR"/subtensor_cert_*.pem 2>/dev/null | head -1)
        LATEST_KEY_BACKUP=$(ls -t "$BACKUP_DIR"/subtensor_key_*.pem 2>/dev/null | head -1)

        if [ -n "$LATEST_CERT_BACKUP" ] && [ -n "$LATEST_KEY_BACKUP" ]; then
            cp "$LATEST_CERT_BACKUP" "$CERT_PATH"
            cp "$LATEST_KEY_BACKUP" "$KEY_PATH"
            log_message "Backup certificates restored"
        fi
    fi
else
    log_message "ERROR: Failed to generate new certificates"
    exit 1
fi

# Clean up old backups (keep last 5)
find "$BACKUP_DIR" -name "subtensor_*.pem" -type f | sort -r | tail -n +11 | xargs rm -f

log_message "SSL certificate rotation completed"
